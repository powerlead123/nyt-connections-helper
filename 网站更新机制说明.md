# NYT Connections 网站更新机制说明

## 🔄 自动更新机制

### 1. 每日自动更新 (GitHub Actions)
- **触发时间**: 每天早上 6:00 UTC (北京时间 14:00)
- **配置文件**: `.github/workflows/daily-update.yml`
- **工作流程**:
  1. GitHub Actions 定时触发
  2. 调用网站的 `/scheduled` 端点
  3. 执行完整的每日更新流程

### 2. 实时API获取 (`/api/today`)
- **触发条件**: 每次用户访问网站时
- **缓存机制**: 
  - 优先从 Cloudflare KV 存储获取缓存数据
  - 如果没有缓存，实时从 Mashable 抓取
  - 缓存有效期: 24小时
- **数据源**: Mashable 网站的每日 Connections 文章

### 3. 手动刷新 (`/api/refresh`)
- **触发方式**: 用户点击网站上的"刷新"按钮
- **功能**: 强制获取最新数据，绕过缓存
- **适用场景**: 当天的谜题还未发布或数据有误时

## 📅 更新时机详解

### 什么时候会获取最新谜题？

1. **每天首次访问**
   - 如果 KV 存储中没有当天的数据
   - 自动从 Mashable 抓取最新谜题

2. **缓存过期后**
   - 24小时后缓存自动过期
   - 下次访问时重新获取

3. **手动刷新**
   - 用户主动点击刷新按钮
   - 立即获取最新数据

4. **定时任务**
   - 每天 6:00 UTC 自动更新
   - 确保数据及时更新

## 🔧 技术实现

### API 端点说明

#### `/api/today` - 获取今日谜题
```javascript
// 工作流程:
1. 检查 KV 存储中是否有今日缓存
2. 如果有缓存且未过期，直接返回
3. 如果没有缓存，实时抓取 Mashable
4. 解析数据并存储到 KV
5. 返回解析后的谜题数据
```

#### `/api/refresh` - 手动刷新
```javascript
// 工作流程:
1. 强制从 Mashable 获取最新数据
2. 解析并验证数据完整性
3. 更新 KV 存储中的缓存
4. 返回刷新结果
```

#### `/scheduled` - 定时任务
```javascript
// 工作流程:
1. 验证调用权限
2. 执行数据抓取和更新
3. 生成每日文章内容
4. 存储到 KV 并设置过期时间
```

### 数据解析逻辑

我们的解析器使用 **hint-based** 方法：

1. **提取提示区域**: 从 "Today's connections fall into the following categories:" 部分
2. **解析分组名称**: 提取 Yellow/Green/Blue/Purple 对应的主题
3. **匹配答案区域**: 在答案部分根据主题名称匹配单词
4. **生成完整数据**: 包含 words, groups, difficulty, theme 等字段

## 🎯 数据格式

### 返回的数据结构
```json
{
  "date": "2025-09-05",
  "words": ["KICK", "PUNCH", "ZEST", "ZING", ...],
  "groups": [
    {
      "theme": "Piquancy",
      "category": "Piquancy", 
      "words": ["KICK", "PUNCH", "ZEST", "ZING"],
      "difficulty": "yellow",
      "hint": "These words are related to \"Piquancy\""
    },
    // ... 其他3个分组
  ]
}
```

### 颜色/难度对应
- **Yellow** (🟡): 最简单
- **Green** (🟢): 简单  
- **Blue** (🔵): 困难
- **Purple** (🟣): 最困难

## 🚀 优化特性

### 1. 多层缓存
- **KV 存储**: 24小时缓存
- **CDN 缓存**: Cloudflare 边缘缓存
- **浏览器缓存**: 客户端缓存

### 2. 容错机制
- **多数据源**: Mashable + 备用数据
- **解析容错**: 多种解析策略
- **降级处理**: 解析失败时返回备用谜题

### 3. 性能优化
- **异步处理**: 非阻塞数据获取
- **超时控制**: 15秒请求超时
- **错误重试**: 多URL尝试机制

## 📊 监控和调试

### 日志记录
- 所有API调用都有详细日志
- 解析过程的调试信息
- 错误和异常追踪

### 状态检查
可以通过以下方式检查系统状态：
- 访问 `/api/today` 查看当前数据
- 查看浏览器控制台的网络请求
- 检查返回数据的 `source` 字段了解数据来源

## 🔄 总结

网站会在以下情况自动获取最新谜题：
1. ✅ **每天首次访问** (无缓存时)
2. ✅ **缓存过期后** (24小时后)  
3. ✅ **手动刷新** (用户主动)
4. ✅ **定时更新** (每天6:00 UTC)

这确保了用户总能获得最新、准确的 NYT Connections 谜题数据！