# 纯读取架构说明

## 🎯 架构原则

我们的网站现在采用**严格的读写分离架构**：

### 📖 读取端（用户访问）
- **只读取KV存储中的数据**
- **不触发任何抓取操作**
- **没有数据时返回404，不尝试获取**

### ✍️ 写入端（数据更新）
- **定时任务**：外部cron服务每日UTC 01:00触发
- **管理员手动**：通过refresh API或scheduled端点手动触发

## 🏗️ 用户访问流程

### 当用户访问网站时

```
用户请求 → /api/today → 检查KV存储 → 返回结果
```

#### 情况1：有数据
```json
{
  "date": "2025-09-12",
  "words": [...],
  "groups": [...],
  "source": "Mashable (Scheduled)"
}
```

#### 情况2：无数据
```json
{
  "error": "No puzzle data available for today",
  "message": "Puzzle data is updated daily via scheduled tasks. Please check back later or contact admin.",
  "date": "2025-09-12",
  "suggestion": "Data is typically available after 9:00 AM Beijing time (01:00 UTC)"
}
```

## 🔄 数据更新流程

### 定时更新（主要方式）
1. **外部cron服务** 每日UTC 01:00触发
2. **调用scheduled端点** 进行数据抓取
3. **解析Mashable内容** 获取谜题数据
4. **存储到KV** 供用户访问

### 手动更新（管理员）
1. **管理员触发** refresh API或scheduled端点
2. **立即抓取** 最新数据
3. **更新KV存储** 覆盖旧数据

## 💾 存储策略

### KV存储键名
- **谜题数据**: `puzzle-2025-09-12`
- **文章内容**: `article-2025-09-12`

### 数据生命周期
- **谜题数据**: 24小时TTL（次日自动过期）
- **文章内容**: 90天TTL（SEO优化）

## 🚫 用户访问不会触发的操作

- ❌ 不会调用fetchTodaysPuzzleData()
- ❌ 不会访问Mashable网站
- ❌ 不会进行HTML解析
- ❌ 不会更新KV存储
- ❌ 不会生成新的文章内容

## ✅ 架构优势

### 性能优势
- **极快响应**：只需要一次KV查询
- **无外部依赖**：不依赖Mashable网站可用性
- **CDN友好**：纯读取操作可以充分利用缓存

### 稳定性优势
- **用户体验稳定**：不会因为抓取失败影响用户
- **资源消耗低**：不会因为用户访问产生额外负载
- **错误隔离**：抓取问题不会影响已有数据的访问

### 维护优势
- **职责清晰**：读写完全分离
- **调试简单**：用户问题和抓取问题分开处理
- **扩展性好**：可以独立优化读取和写入逻辑

## 🔧 故障处理

### 如果用户看到404错误
1. **检查定时任务**：确认cron服务是否正常执行
2. **检查KV存储**：确认数据是否成功写入
3. **手动触发**：管理员可以手动更新数据

### 如果数据过期
- **自动过期**：KV会自动清理过期数据
- **定时更新**：新数据会在下次定时任务时更新
- **无缝切换**：用户不会看到过期数据

## 📊 监控要点

### 用户端监控
- **404错误率**：监控无数据的情况
- **响应时间**：KV读取性能
- **缓存命中率**：CDN缓存效果

### 数据端监控
- **定时任务成功率**：确保数据及时更新
- **KV存储状态**：确认数据正确写入
- **数据完整性**：验证存储的数据质量

这个架构确保了用户访问的高性能和稳定性，同时保持了数据更新的可控性。