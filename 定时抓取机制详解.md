# 定时抓取机制详解

## 1. 定时抓取的时机

### 外部定时服务 (cron-job.org)
**配置信息**：
- **服务**: cron-job.org (免费)
- **Cron表达式**: `0 1 * * *`
- **时区**: UTC

**触发时间**：
- **UTC时间**：每天 01:00
- **北京时间**：每天 09:00
- **美国东部时间**：前一天 21:00（夏令时）或 20:00（标准时间）

## 2. 定时抓取的完整流程

### 步骤1：外部定时服务触发
```bash
# cron-job.org 执行
curl -X POST https://nyt-connections-helper.pages.dev/scheduled \
  -H "Content-Type: application/json" \
  -d '{"action":"daily-update","secret":"your-secret-key"}'
```

### 步骤2：Cloudflare Functions 处理
```javascript
// functions/scheduled.js
switch (action) {
    case 'daily-update':
        const scrapeResult = await scrapeAndUpdateData(env);
        const articleResult = await generateDailyArticle(env);
        result = { scrape: scrapeResult, article: articleResult };
        break;
}
```

### 步骤3：数据抓取和解析
```javascript
// scrapeAndUpdateData() 函数
const puzzleData = await fetchTodaysPuzzleData();

// fetchTodaysPuzzleData() 调用
const mashableData = await fetchFromMashable();

// fetchFromMashable() 执行
1. 构建URL: https://mashable.com/article/nyt-connections-hint-answer-today-september-12-2025
2. 发送HTTP请求获取HTML
3. 调用 parseMashableHTML() 解析内容
4. 提取4个分组的主题和单词
```

### 步骤4：数据存储
```javascript
// 保存到KV存储
await env.CONNECTIONS_KV.put(`puzzle-${today}`, JSON.stringify(puzzleData), {
    expirationTtl: 86400 // 24小时过期
});
```

### 步骤5：文章生成
```javascript
// generateDailyArticle() 函数
const article = generateArticleHTML(puzzleData, today);
await env.CONNECTIONS_KV.put(`article-${today}`, article, {
    expirationTtl: 86400 * 90 // 90天过期，SEO优化
});
```

## 3. 用户访问时的逻辑

### 用户打开网站首页
```javascript
// script.js - 页面加载时
document.addEventListener('DOMContentLoaded', () => {
    initializePage(); // 自动调用
});

// initializePage() 调用
await loadTodaysPuzzle();

// loadTodaysPuzzle() 发送请求
const response = await fetch('/api/today?t=' + Date.now());
```

### today.js API 处理逻辑
```javascript
// functions/api/today.js
export async function onRequest(context) {
    const today = new Date().toISOString().split('T')[0];
    
    // 1. 优先从KV缓存获取
    const cached = await env.CONNECTIONS_KV.get(`puzzle-${today}`);
    if (cached) {
        return JSON.parse(cached); // 直接返回缓存数据
    }
    
    // 2. 缓存未命中时才实时抓取
    const puzzleData = await fetchTodaysPuzzleData();
    
    // 3. 保存到KV缓存
    if (puzzleData) {
        await env.CONNECTIONS_KV.put(`puzzle-${today}`, JSON.stringify(puzzleData));
    }
    
    return puzzleData;
}
```

## 4. 当前问题分析

### 为什么显示 "Backup (Simple)"？

**可能的原因**：

1. **定时任务还没运行**
   - 今天是9月12日11:00（北京时间）
   - 定时任务在UTC 01:00运行（北京时间09:00）
   - 如果任务失败或延迟，就会使用旧缓存

2. **KV缓存中有旧数据**
   - 可能存储了昨天的数据或解析失败的数据
   - today.js 优先使用缓存，不会重新抓取

3. **解析逻辑失败**
   - Mashable页面结构变化
   - 解析函数返回null，使用备用数据

4. **时区问题**
   - 不同环境的日期字符串不一致
   - 导致KV键名不匹配

## 5. 解决方案

### 立即解决（手动）
```bash
# 方法1：手动触发GitHub Actions
# 在GitHub仓库页面 -> Actions -> Daily NYT Connections Update -> Run workflow

# 方法2：调用refresh API
curl -X POST https://nyt-connections-helper.pages.dev/api/refresh
```

### 长期解决（自动）
1. **确保定时任务正常运行**
2. **优化解析逻辑的容错性**
3. **添加监控和告警机制**
4. **统一时区处理**

## 6. 数据流向图

```
外部定时服务 (UTC 01:00)
    ↓
Cloudflare Functions (/scheduled)
    ↓
fetchTodaysPuzzleData()
    ↓
fetchFromMashable() → parseMashableHTML()
    ↓
KV Storage (puzzle-2025-09-12)
    ↓
用户访问首页
    ↓
/api/today → 从KV获取数据
    ↓
前端显示谜题
```

## 7. 关键时间点

- **NYT发布**：美国东部时间 00:00
- **Mashable发布**：通常在NYT发布后2-6小时
- **我们抓取**：UTC 01:00（确保内容已发布）
- **用户访问**：任何时间（从KV缓存获取）