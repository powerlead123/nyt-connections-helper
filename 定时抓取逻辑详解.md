# 定时抓取逻辑详解 ⏰

## 整体架构 🏗️

我们的定时抓取系统采用**GitHub Actions + Cloudflare Pages Functions**的架构：

```
GitHub Actions (定时触发) → Cloudflare Pages Functions (执行抓取) → KV存储 (保存数据)
```

## 1. 定时触发机制 📅

### GitHub Actions配置
```yaml
# .github/workflows/daily-update.yml
on:
  schedule:
    - cron: '0 6 * * *'  # 每天UTC 6:00 (北京时间14:00)
  workflow_dispatch:      # 支持手动触发
```

### 触发流程
```
每天UTC 6:00 → GitHub Actions启动 → 调用Cloudflare Pages Function
```

### 调用命令
```bash
curl -X POST https://nyt-connections-helper.pages.dev/scheduled \
  -H "Content-Type: application/json" \
  -d '{"action":"daily-update","secret":"${{ secrets.CRON_SECRET }}"}'
```

---

## 2. 主要处理逻辑 🔄

### scheduled.js的核心流程

```javascript
export async function onRequest(context) {
    // 1. 验证请求和密钥
    // 2. 根据action执行不同任务
    switch (action) {
        case 'daily-update':
            // 完整的每日更新流程
            const scrapeResult = await scrapeAndUpdateData(env);
            const articleResult = await generateDailyArticle(env);
            break;
    }
}
```

### 数据抓取流程
```
scrapeAndUpdateData() → fetchTodaysPuzzleData() → 多数据源尝试 → 保存到KV
```

---

## 3. 数据源策略 📊

### 数据源优先级
1. **NYT官方** (fetchFromNYT) - 最权威但可能有限制
2. **Mashable** (fetchFromMashable) - 主要数据源
3. **备用数据** (getBackupPuzzle) - 兜底方案

### Mashable抓取策略

#### URL尝试策略 (3个URL格式)
```javascript
const urls = [
    `https://mashable.com/article/nyt-connections-hint-answer-today-${monthName}-${dayNum}-${year}`,
    `https://mashable.com/article/nyt-connections-answer-today-${monthName}-${dayNum}-${year}`,
    `https://mashable.com/article/connections-hint-answer-today-${monthName}-${dayNum}-${year}`
];
```

#### 代理服务策略 (3个代理)
```javascript
const proxyServices = [
    (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,  // 主要代理
    (url) => `https://cors-anywhere.herokuapp.com/${url}`,                    // 备用代理
    (url) => url                                                              // 直接访问
];
```

#### 组合策略
```
3个URL × 3个代理 = 9种尝试组合
```

---

## 4. 解析逻辑 🧩

### parseMashableHTML函数特点

#### 1. 日期验证
```javascript
// 确认是今天的文章
const datePatterns = [
    new RegExp(`${monthName}\\s+${day}`, 'i'),
    new RegExp(`${day}\\s+${monthName}`, 'i'),
    // ... 更多格式
];
```

#### 2. 颜色提示提取
```javascript
const improvedAnswerPattern = /(Yellow|Green|Blue|Purple)[\s\S]*?<strong[^>]*>([^<]+)<\/strong>/gi;
const colorMatches = [...html.matchAll(improvedAnswerPattern)];
```

#### 3. 单词提取策略
- **逗号分隔的大写单词**
- **列表项中的单词**
- **强调标签中的单词**

#### 4. 多层备用解析
- 主要解析失败 → 备用模式1
- 备用模式1失败 → 备用模式2
- 最终兜底 → 返回null

---

## 5. 数据处理流程 💾

### 成功抓取后的处理
```javascript
if (puzzleData) {
    // 1. 保存谜题数据到KV
    await env.CONNECTIONS_KV.put(`puzzle-${today}`, JSON.stringify(puzzleData), {
        expirationTtl: 86400 // 24小时过期
    });
    
    // 2. 生成文章HTML
    const article = generateArticleHTML(puzzleData, today);
    
    // 3. 保存文章到KV
    await env.CONNECTIONS_KV.put(`article-${today}`, article, {
        expirationTtl: 86400 * 7 // 7天过期
    });
}
```

### 数据结构
```javascript
{
    date: "2025-09-09",
    words: ["WORD1", "WORD2", ...],
    groups: [
        {
            theme: "分组主题",
            words: ["WORD1", "WORD2", "WORD3", "WORD4"],
            difficulty: "yellow|green|blue|purple",
            hint: "提示信息"
        }
    ],
    source: "Mashable (Scheduled)"
}
```

---

## 6. 错误处理机制 🛡️

### 多层容错
1. **URL级别**: 一个URL失败，尝试下一个
2. **代理级别**: 一个代理失败，尝试下一个
3. **数据源级别**: Mashable失败，尝试NYT
4. **系统级别**: 所有失败，返回备用数据

### 超时控制
```javascript
signal: AbortSignal.timeout(15000)  // 15秒超时
```

### 日志记录
```javascript
console.log(`Trying URL: ${url}`);
console.log(`Successfully fetched HTML, length: ${html.length}`);
console.log('Successfully parsed Mashable data');
```

---

## 7. 与手动刷新的区别 🔄

| 特性 | 定时抓取 (scheduled.js) | 手动刷新 (refresh.js) |
|------|------------------------|----------------------|
| **触发方式** | GitHub Actions定时 | 管理员手动点击 |
| **URL数量** | 3个备用URL | 1个主要URL |
| **代理数量** | 3个代理服务 | 2个精选代理 |
| **超时时间** | 15秒 | 20秒 |
| **错误处理** | 多层备用策略 | 返回现有数据 |
| **数据验证** | 严格日期验证 | 简化验证 |
| **附加功能** | 生成文章HTML | 仅更新数据 |

---

## 8. 执行时间安排 ⏱️

### 时区考虑
- **GitHub Actions**: UTC 6:00
- **北京时间**: 14:00 (下午2点)
- **美国东部时间**: 2:00 AM (凌晨2点)

### 选择原因
- NYT Connections通常在美国东部时间凌晨发布
- 给Mashable等网站时间发布解答文章
- 避开用户访问高峰期

---

## 9. 监控和调试 🔍

### 成功指标
- KV中存在 `puzzle-${today}` 数据
- KV中存在 `article-${today}` 文章
- 数据包含4个完整分组

### 失败排查
1. 检查GitHub Actions执行日志
2. 检查Cloudflare Pages Functions日志
3. 验证KV存储内容
4. 测试Mashable URL可访问性

### 手动触发
```bash
# GitHub Actions手动触发
# 或直接调用API
curl -X POST https://nyt-connections-helper.pages.dev/scheduled \
  -H "Content-Type: application/json" \
  -d '{"action":"daily-update","secret":"your-secret"}'
```

---

## 总结 📝

我们的定时抓取逻辑是一个**高可靠性、多重备用**的自动化系统：

✅ **自动化**: GitHub Actions定时触发，无需人工干预
✅ **高可靠**: 9种URL+代理组合，多数据源备用
✅ **智能解析**: 多种HTML解析策略，适应网站变化
✅ **完整流程**: 数据抓取 + 文章生成 + KV存储
✅ **错误容错**: 多层备用机制，确保服务可用

这套系统确保每天都能自动获取最新的NYT Connections数据，为用户提供稳定的服务！ 🎯